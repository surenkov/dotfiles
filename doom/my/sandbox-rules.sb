(version 1)

(allow default)
(deny network*)

(deny file-read* file-write*
      (subpath "/")
      (subpath (param "HOME_DIR"))
      (subpath (string-append (param "HOME_DIR") "/.ssh")))

(allow file-read*
       (literal "/")
       (literal "/Users")
       (literal (param "HOME_DIR"))

       (subpath "/usr")
       (subpath "/bin")
       (subpath "/opt")
       (subpath "/var")
       (subpath "/etc")
       (subpath "/private/var")
       (subpath "/System")

       ;; Git configuration
       (literal (string-append (param "HOME_DIR") "/.gitconfig"))
       (literal (string-append (param "HOME_DIR") "/.ripgreprc"))
       (subpath (string-append (param "HOME_DIR") "/.config"))

       (subpath (string-append (param "HOME_DIR") "/.local"))
       (subpath (string-append (param "HOME_DIR") "/.pyenv")))

;; Allow process execution and forking (children inherit policy)
(allow process-exec)
(allow process-fork)
;; Essential permissions - based on Chrome sandbox policy
;; Process permissions - from https://github.com/anthropic-experimental/sandbox-runtime/blob/1bafa66a2c3ebc52569fc0c1a868e85e778f66a0/src/sandbox/macos-sandbox-utils.ts#L200
(allow process-info* (target same-sandbox))
;; Allow signals to all children
(allow signal (target same-sandbox))
(allow mach-priv-task-port (target same-sandbox))

;; Allow file writes to specific paths only
;; Note: file-write* does NOT include file-write-create, so we need both
(allow file-read* file-write* file-write-create file-read-metadata file-ioctl
    ;; Project directory - primary workspace
    (subpath (param "TARGET_DIR"))

    ;; Temporary directories
    (subpath (param "TMP_DIR"))
    (subpath "/tmp")
    (subpath "/private/tmp")
    (subpath "/var/folders")  ; macOS temp directory root
    (subpath "/private/var/folders")  ; Real path (var is symlink to private/var)

    ;; Cache directory
    (subpath (string-append (param "HOME_DIR") "/.cache"))
    (subpath (string-append (param "HOME_DIR") "/Library/Caches"))

    ;; Standard I/O devices
    (literal "/dev/stdout")
    (literal "/dev/stderr")
    (literal "/dev/null")
    (literal "/dev/zero")
    (literal "/dev/tty")
    (literal "/dev/ptmx")
    (literal "/dev/urandom")
    (literal "/dev/random")
    (regex #"^/dev/tty*")
    (regex #"^/dev/pty*"))

;; Whitelisted directories
(for-each (lambda (path) (allow file-read* (subpath path)))
                 (split-string (param "WHITELIST_DIRS") ":"))
